<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç™»å…¥ / è¨»å†Š - SimpleChat</title>
  <link rel="stylesheet" href="style2.css" />
  <link rel="icon" href="favicon.ico" />
</head>
<body>
  <div class="container">
    <h2 id="formTitle">ç™»å…¥ SimpleChat</h2>

    <input type="email" id="email" placeholder="é›»å­éƒµä»¶" />

    <div class="password-wrapper">
      <input type="password" id="password" placeholder="å¯†ç¢¼(è‡³å°‘6ç¢¼)" />
      <span id="togglePassword" title="é¡¯ç¤º/éš±è—å¯†ç¢¼">ğŸ‘ï¸</span>
    </div>

    <input type="text" id="nickname" placeholder="æš±ç¨±ï¼ˆ3â€“24 å­—ï¼›è¨»å†Šæ™‚å¡«å¯«ï¼‰" style="display:none" />

    <button id="submitBtn">ç™»å…¥</button>

    <div class="toggle" id="toggleForm">æ²’æœ‰æˆ–å·²æœ‰å¸³è™Ÿï¼Ÿ<span class="blue">é»æ­¤è¨»å†Š / ç™»å…¥</span></div>
    <div class="toggle" style="margin-top:8px"><span class="blue" id="forgot">å¿˜è¨˜å¯†ç¢¼ï¼Ÿé»æ­¤é‡è¨­</span></div>

    <div id="infoMsg" class="info" style="text-align:center; margin-top:8px; color:#9ad">
      è¨»å†Šå¾Œæœƒå¯„å‡ºé©—è­‰ä¿¡ï¼›æœªé©—è­‰å‰å¯ä»¥ç™»å…¥ï¼Œä½†ç„¡æ³•ç™¼è©±ã€‚
    </div>
    <div id="errorMsg" class="error"></div>
  </div>

<script type="module">
  import { auth, db } from './firebase.js';
  import {
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    sendEmailVerification,
    sendPasswordResetEmail
  } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
  import { ref, set, runTransaction } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

  const email       = document.getElementById('email');
  const password    = document.getElementById('password');
  const nickname    = document.getElementById('nickname');
  const submitBtn   = document.getElementById('submitBtn');
  const toggleForm  = document.getElementById('toggleForm');
  const formTitle   = document.getElementById('formTitle');
  const errorMsg    = document.getElementById('errorMsg');
  const infoMsg     = document.getElementById('infoMsg');
  const togglePwd   = document.getElementById('togglePassword');
  const forgot      = document.getElementById('forgot');

  let isLogin = true;

  togglePwd.addEventListener('click', () => {
    password.type = password.type === 'password' ? 'text' : 'password';
  });

  toggleForm.addEventListener('click', () => {
    isLogin = !isLogin;
    formTitle.textContent = isLogin ? 'ç™»å…¥ SimpleChat' : 'è¨»å†Š SimpleChat';
    submitBtn.textContent = isLogin ? 'ç™»å…¥' : 'è¨»å†Š';
    nickname.style.display = isLogin ? 'none' : 'block';
    errorMsg.textContent = '';
  });

  forgot.addEventListener('click', async () => {
    errorMsg.textContent = '';
    const emailVal = (email.value || '').trim();
    if (!emailVal) { errorMsg.textContent = 'è«‹å…ˆè¼¸å…¥é›»å­éƒµä»¶å†æŒ‰é‡è¨­'; return; }
    try {
      await sendPasswordResetEmail(auth, emailVal);
      infoMsg.textContent = 'é‡è¨­å¯†ç¢¼é€£çµå·²å¯„å‡ºï¼Œè«‹æŸ¥æ”¶éƒµä»¶(å¯èƒ½ä½æ–¼åƒåœ¾éƒµä»¶)ã€‚';
    } catch (err) {
      errorMsg.textContent = mapAuthErrorToZh(err);
    }
  });

  submitBtn.addEventListener('click', handleSubmit);
  [email, password, nickname].forEach((el) => {
    el.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSubmit(); });
  });

  async function handleSubmit() {
    errorMsg.textContent = '';
    const emailVal = (email.value || '').trim();
    const pwdVal   = (password.value || '').trim();
    const nick     = (nickname.value || '').trim();

    if (!emailVal || !pwdVal || (!isLogin && !nick)) {
      errorMsg.textContent = 'è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½';
      return;
    }

    submitBtn.disabled = true;

    try {
      if (isLogin) {
        await signInWithEmailAndPassword(auth, emailVal, pwdVal);
        window.location.href = 'chat.html';
      } else {
        if (nick.length < 3 || nick.length > 24) {
          errorMsg.textContent = 'æš±ç¨±éœ€ 3â€“24 å­—';
          submitBtn.disabled = false; return;
        }
        const lower = nick.toLowerCase();

        const cred = await createUserWithEmailAndPassword(auth, emailVal, pwdVal);
        const uid  = cred.user.uid;

        // æš±ç¨±å”¯ä¸€æª¢æŸ¥
        const res = await runTransaction(ref(db, `nicknames/${lower}`), (cur) => {
          if (cur === null || cur === uid) return uid;
          return;
        });
        if (!res.committed) {
          throw new Error('æš±ç¨±å·²è¢«ä½¿ç”¨ï¼Œè«‹æ›ä¸€å€‹');
        }

        // å»ºç«‹ä½¿ç”¨è€…è³‡æ–™
        await set(ref(db, `users/${uid}/profile`), {
          nickname: nick,
          nicknameLower: lower,
          registeredAt: Date.now()
        });
        await set(ref(db, `users/${uid}/private`), { email: emailVal });

        // æš«å­˜æš±ç¨±ï¼Œé¿å…èŠå¤©å®¤ç¬¬ä¸€æ¬¡è®€ä¸åˆ°
        localStorage.setItem('pendingNickname', nick);

        // é©—è­‰ä¿¡
        try {
          await sendEmailVerification(cred.user);
          alert('é©—è­‰ä¿¡å·²å¯„å‡ºï¼Œè«‹åˆ°ä¿¡ç®±æ”¶ä¿¡ï¼ˆå¯èƒ½åœ¨åƒåœ¾éƒµä»¶ï¼‰');
        } catch {
          alert('é©—è­‰ä¿¡å¯„é€å¤±æ•—ï¼Œå¯åœ¨èŠå¤©å®¤å³ä¸Šè§’å†å¯„ä¸€æ¬¡');
        }

        // âœ… é€™è£¡æ‰ redirectï¼Œä¿è­‰ DB å·²å¯«å…¥
        window.location.href = 'chat.html';
      }
    } catch (err) {
      errorMsg.textContent = mapAuthErrorToZh(err);
      submitBtn.disabled = false;
    }
  }

  function mapAuthErrorToZh(error) {
    const code = error?.code || '';
    switch (code) {
      case 'auth/invalid-email': return 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º';
      case 'auth/email-already-in-use': return 'æ­¤ä¿¡ç®±å·²è¢«è¨»å†Š';
      case 'auth/user-not-found': return 'å¸³è™Ÿä¸å­˜åœ¨';
      case 'auth/wrong-password': return 'å¯†ç¢¼éŒ¯èª¤';
      case 'auth/weak-password': return 'å¯†ç¢¼éœ€è‡³å°‘ 6 ç¢¼';
      case 'auth/network-request-failed': return 'ç¶²è·¯ç•°å¸¸ï¼Œè«‹æª¢æŸ¥é€£ç·š';
      case 'auth/invalid-login-credentials': return 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
      case 'auth/too-many-requests': return 'å˜—è©¦éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦';
      default: return `ç™¼ç”ŸéŒ¯èª¤ï¼š${error?.message || String(error)}`;
    }
  }
</script>
</body>
</html>