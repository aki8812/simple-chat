<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>登入 / 註冊 - SimpleChat</title>
  <link rel="stylesheet" href="style2.css" />
  <link rel="icon" href="favicon.ico" />
</head>
<body>
  <div class="container">
    <h2 id="formTitle">登入 SimpleChat</h2>

    <input type="email" id="email" placeholder="電子郵件" />

    <div class="password-wrapper">
      <input type="password" id="password" placeholder="密碼(至少6碼)" />
      <span id="togglePassword" title="顯示/隱藏密碼">👁️</span>
    </div>

    <input type="text" id="nickname" placeholder="暱稱（3–24 字；註冊時填寫）" style="display:none" />

    <button id="submitBtn">登入</button>

    <div class="toggle" id="toggleForm">沒有或已有帳號？<span class="blue">點此註冊 / 登入</span></div>
    <div class="toggle" style="margin-top:8px"><span class="blue" id="forgot">忘記密碼？點此重設</span></div>

    <div id="infoMsg" class="info" style="text-align:center; margin-top:8px; color:#9ad">
      註冊後會寄出驗證信；未驗證前可以登入，但無法發話。
    </div>
    <div id="errorMsg" class="error"></div>
  </div>

<script type="module">
  // ===== 模組載入 =====
  import { auth, db } from './firebase.js';
  import {
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    sendEmailVerification,
    sendPasswordResetEmail
  } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
  import { ref, set, runTransaction } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

  // ===== DOM =====
  const email       = document.getElementById('email');
  const password    = document.getElementById('password');
  const nickname    = document.getElementById('nickname');
  const submitBtn   = document.getElementById('submitBtn');
  const toggleForm  = document.getElementById('toggleForm');
  const formTitle   = document.getElementById('formTitle');
  const errorMsg    = document.getElementById('errorMsg');
  const infoMsg     = document.getElementById('infoMsg');
  const togglePwd   = document.getElementById('togglePassword');
  const forgot      = document.getElementById('forgot');

  let isLogin = true;

  console.log('[INIT] login.html loaded');

  // 顯示/隱藏密碼
  togglePwd.addEventListener('click', () => {
    password.type = password.type === 'password' ? 'text' : 'password';
  });

  // 切換登入/註冊模式
  toggleForm.addEventListener('click', () => {
    isLogin = !isLogin;
    formTitle.textContent = isLogin ? '登入 SimpleChat' : '註冊 SimpleChat';
    submitBtn.textContent = isLogin ? '登入' : '註冊';
    nickname.style.display = isLogin ? 'none' : 'block';
    errorMsg.textContent = '';
    console.log('[UI] mode =', isLogin ? 'login' : 'register');
  });

  // 忘記密碼
  forgot.addEventListener('click', async () => {
    errorMsg.textContent = '';
    const emailVal = (email.value || '').trim();
    if (!emailVal) { errorMsg.textContent = '請先輸入電子郵件再按重設'; return; }
    try {
      await sendPasswordResetEmail(auth, emailVal);
      infoMsg.textContent = '重設密碼連結已寄出，請查收郵件(可能位於垃圾郵件)。';
    } catch (err) {
      errorMsg.textContent = mapAuthErrorToZh(err);
    }
  });

  // 送出
  submitBtn.addEventListener('click', handleSubmit);
  ;[email, password, nickname].forEach((el) => {
    el.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSubmit(); });
  });

  async function handleSubmit() {
    errorMsg.textContent = '';
    const emailVal = (email.value || '').trim();
    const pwdVal   = (password.value || '').trim();
    const nick     = (nickname.value || '').trim();

    if (!emailVal || !pwdVal || (!isLogin && !nick)) {
      errorMsg.textContent = '請完整填寫所有欄位';
      return;
    }

    submitBtn.disabled = true;

    try {
      if (isLogin) {
        console.log('[STEP] LOGIN start');
        await signInWithEmailAndPassword(auth, emailVal, pwdVal);
        console.log('[STEP] LOGIN done');
      } else {
        if (nick.length < 3 || nick.length > 24) {
          errorMsg.textContent = '暱稱需 3–24 字';
          submitBtn.disabled = false; return;
        }
        const lower = nick.toLowerCase();

        // 1) 建立帳號（自動登入）
        console.log('[STEP] REGISTER create user');
        const cred = await createUserWithEmailAndPassword(auth, emailVal, pwdVal);
        const uid  = cred.user.uid;
        console.log('[STEP] REGISTER created uid =', uid);

        // 2) 嘗試佔用暱稱（唯一）
        console.log('[STEP] REGISTER transaction nicknames/', lower);
        const res = await runTransaction(ref(db, `nicknames/${lower}`), (cur) => {
          if (cur === null || cur === uid) return uid;
          return;
        });
        if (!res.committed) {
          throw new Error('暱稱已被使用，請換一個');
        }
        console.log('[STEP] REGISTER nickname reserved');

        // 3) 建立使用者資料（必定寫入 DB）
        console.log('[STEP] REGISTER write users profile/private');
        await set(ref(db, `users/${uid}/profile`), {
          nickname: nick,
          nicknameLower: lower,
          registeredAt: Date.now()
        });
        await set(ref(db, `users/${uid}/private`), { email: emailVal });
        console.log('[STEP] REGISTER users written');

        // 4) 寄送驗證信（顯示結果，不阻擋流程）
        try {
          console.log('[STEP] REGISTER send verification email');
          await sendEmailVerification(cred.user);
          alert('驗證信已寄出，請到信箱收信（可能在垃圾郵件）');
          console.log('[STEP] REGISTER email sent');
        } catch (e) {
          console.warn('[WARN] verification email failed', e);
          alert('驗證信寄送失敗，可在聊天室右上角再寄一次');
        }

        // 5) （可選）讓聊天室先顯示暱稱
        localStorage.setItem('pendingNickname', nick);
      }

      console.log('[STEP] redirect -> chat.html');
      window.location.href = 'chat.html';
    } catch (err) {
      console.error('[ERROR]', err);
      errorMsg.textContent = mapAuthErrorToZh(err);
      submitBtn.disabled = false;
    }
  }

  // 已登入者直接跳轉（注意：這行放最後，避免干擾註冊寫入流程）
  onAuthStateChanged(auth, (u) => { if (u) { console.log('[AUTH] logged in, redirect'); window.location.href = 'chat.html'; } });

  function mapAuthErrorToZh(error) {
    const code = error?.code || '';
    switch (code) {
      case 'auth/invalid-email': return '電子郵件格式不正確';
      case 'auth/email-already-in-use': return '此信箱已被註冊';
      case 'auth/user-not-found': return '帳號不存在';
      case 'auth/wrong-password': return '密碼錯誤';
      case 'auth/weak-password': return '密碼需至少 6 碼';
      case 'auth/network-request-failed': return '網路異常，請檢查連線';
      case 'auth/invalid-login-credentials': return '帳號或密碼錯誤';
      case 'auth/too-many-requests': return '嘗試過於頻繁，請稍後再試';
      default: return `發生錯誤：${error?.message || String(error)}`;
    }
  }
</script>
</body>
</html>