<!DOCTYPE html>
const existed = await get(ref(db, `nicknames/${lower}`));
if (existed.exists()) { errorMsg.textContent = '暱稱已被使用，請換一個'; return; }


const cred = await createUserWithEmailAndPassword(auth, emailVal, pwdVal);
const uid = cred.user.uid;


// 以交易方式佔用暱稱（防競態）
const res = await runTransaction(ref(db, `nicknames/${lower}`), (cur) => {
if (cur === null) return uid; // 佔用成功
return; // 中止交易
});
if (!res.committed) { throw new Error('暱稱已被使用，請換一個'); }


await set(ref(db, `users/${uid}/profile`), {
nickname: nick,
nicknameLower: lower,
registeredAt: Date.now()
});
await set(ref(db, `users/${uid}/private`), { email: emailVal });


// 寄送驗證信（登入後即可去聊天室，但未驗證無法發話）
await sendEmailVerification(cred.user);
}
window.location.href = 'chat.html';
} catch (err) {
errorMsg.textContent = mapAuthErrorToZh(err);
}
}


;[email, password, nickname].forEach((el) => {
el.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSubmit(); });
});


onAuthStateChanged(auth, (u) => { if (u) window.location.href = 'chat.html'; });


function mapAuthErrorToZh(error) {
const code = error?.code || '';
switch (code) {
case 'auth/invalid-email': return '電子郵件格式不正確';
case 'auth/email-already-in-use': return '此信箱已被註冊';
case 'auth/user-not-found': return '帳號不存在';
case 'auth/wrong-password': return '密碼錯誤';
case 'auth/weak-password': return '密碼需至少 6 碼';
case 'auth/network-request-failed': return '網路異常，請檢查連線';
default: return `發生錯誤：${error?.message || String(error)}`;
}
}
</script>
</body>
</html>