<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>載入中…</title>
  <link rel="icon" href="favicon.ico" />
  <style>
    body { background:#2c2f33; color:#fff; font-family:sans-serif; text-align:center; padding-top:100px; margin:0; }
  </style>
</head>
<body>
  <h1>Redirecting…</h1>


  <script type="module">

    const hardFailToLogin = (why) => {
      try { console.error('[redirect guard]', why); } catch {}
      try { window.location.replace('login.html'); } catch {}
    };


    Promise.resolve()
      .then(async () => {
        try {
          const [{ auth }, { onAuthStateChanged }] = await Promise.all([
            import('./firebase.js'),
            import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js')
          ]);

          let redirected = false;
          const go = (url) => {
            if (redirected) return;
            redirected = true;
            window.location.replace(url);
          };


          const safetyTimer = setTimeout(() => go('login.html'), 3000);

          onAuthStateChanged(auth, (user) => {
            clearTimeout(safetyTimer);
            if (user) go('chat.html');
            else go('login.html');
          }, (err) => {
            console.error('onAuthStateChanged error', err);
            go('login.html');
          });
        } catch (e) {
          hardFailToLogin(e);
        }
      })
      .catch(hardFailToLogin);
  </script>
</body>
</html>
