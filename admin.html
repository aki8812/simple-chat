<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SimpleChat Admin</title>
  <link rel="stylesheet" href="style3.css" />
  <link rel="icon" href="favicon.ico" />
</head>
<body>
  <div class="app-admin">
    <header class="topbar">
      <div class="brand" id="toChat">← 返回聊天室</div>
      <div class="title">成員管理</div>
    </header>

    <section id="listBox" class="list-box" aria-live="polite"></section>
  </div>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { ref, onValue, get, set, remove } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    const listBox = document.getElementById('listBox');
    document.getElementById('toChat').onclick = () => (location.href = 'chat.html');

    let me = null;
    const users = new Map();
    const adminsSet = new Set();
    const bansSet   = new Set();
    let isInitialAdminLoad = true; // ★ 修正點：新增一個旗標，用於區分初次載入和後續更新

    const PAGE = 25;
    let normalSorted = [];
    let normalRendered = 0;

    onAuthStateChanged(auth, async (u) => {
      if (!u) return (location.href = 'login.html');
      me = u;
      
      // 初始權限檢查：這部分邏輯是正確的
      try {
        const adminSnap = await get(ref(db, 'admins'));
        if (!adminSnap.exists() || !adminSnap.hasChild(me.uid)) {
          alert('你不是管理員，無法進入此頁面。');
          location.href = 'chat.html';
          return;
        }
        
        // 權限通過，載入頁面
        initialLoad();

      } catch (error) {
        alert('檢查權限時發生錯誤，請稍後再試。');
        location.href = 'chat.html';
      }
    });

    function initialLoad() {
      // 監聽 admins 節點
      onValue(ref(db, 'admins'), (snap) => {
        adminsSet.clear();
        snap.forEach(ch => adminsSet.add(ch.key));

        // ★ 修正點：使用旗標來區分
        if (isInitialAdminLoad) {
          // 這是第一次執行，因為 get() 已經確認過權限，所以直接繼續
          isInitialAdminLoad = false;
        } else {
          // 這不是第一次執行，表示 admins 列表發生了變化
          // 此時才需要檢查權限是否被移除
          if (!adminsSet.has(me.uid)) {
            alert('你的管理員權限已被移除。');
            location.href = 'chat.html';
            return; // 權限沒了，不用再繼續執行
          }
        }
        rebuild(); // 重建列表
      });
      
      // 監聽 bans 和 users (這部分不變)
      onValue(ref(db, 'bans'),   (snap) => { bansSet.clear();   snap.forEach(ch => bansSet.add(ch.key));   rebuild(); });
      onValue(ref(db, 'users'),  (snap) => {
        users.clear();
        snap.forEach(u => { const p=u.val()?.profile; if (p) users.set(u.key, p); });
        rebuild();
      });

      listBox.addEventListener('scroll', () => {
        if (listBox.scrollTop + listBox.clientHeight >= listBox.scrollHeight - 20) {
          renderMore();
        }
      });
    }

    function rebuild() {
      if (!me || users.size === 0) return;

      const admins = [], banned = [], normal = [];
      users.forEach((p, uid) => {
        const rec = { uid, ...p };
        if (adminsSet.has(uid)) admins.push(rec);
        else if (bansSet.has(uid)) banned.push(rec);
        else normal.push(rec);
      });
      const cmp = (a,b)=>a.nickname.localeCompare(b.nickname,'zh-Hant');
      admins.sort(cmp); banned.sort(cmp); normal.sort(cmp);

      normalSorted = normal;
      normalRendered = 0;

      listBox.innerHTML = sectionHtml('---管理員---', admins) +
                          sectionHtml('---封鎖成員---', banned) +
                          `<div class="section-title">---普通成員---</div><div id="normalList"></div>`;
      renderMore();
      bindRowEvents(listBox);
    }

    function sectionHtml(title, arr) {
      const rows = arr.map(rowHtml).join('') || '<div class="empty">（無）</div>';
      return `<div class="section-title">${title}</div>${rows}`;
    }

    function rowHtml(u) {
      const isAdm = adminsSet.has(u.uid);
      const isBan = bansSet.has(u.uid);
      const cls = ['member-row', isAdm?'admin':'', isBan?'banned':''].filter(Boolean).join(' ');
      return `
        <div class="${cls}" data-uid="${u.uid}">
          <div class="member-head">
            <span class="name">${u.nickname}</span>
            ${isAdm ? '<span class="tag-admin">[管理員]</span>' : ''}
            <button class="toggle">▼</button>
          </div>
          <div class="member-body hidden">
            <div>電子郵件：<span class="email" data-uid="${u.uid}">（點上方▼載入）</span></div>
            <div>註冊時間：${fmt(u.registeredAt)}</div>
            <div style="margin-top:8px">
              ${u.uid === me.uid || isAdm ? '' : `<button class="${isBan?'':'danger'} ban-btn">${isBan?'解封鎖':'封鎖'}</button>`}
            </div>
          </div>
        </div>`;
    }

    function renderMore() {
      const list = document.getElementById('normalList');
      if (!list) return;
      const next = normalSorted.slice(normalRendered, normalRendered + PAGE);
      if (next.length === 0 && normalRendered === 0) {
        list.innerHTML = '<div class="empty">（無）</div>';
      } else {
        list.insertAdjacentHTML('beforeend', next.map(rowHtml).join(''));
        normalRendered += next.length;
        bindRowEvents(list);
      }
    }

    function bindRowEvents(root) {
      root.querySelectorAll('.member-row .toggle').forEach(btn => {
        if (btn.dataset.bound) return;
        btn.dataset.bound = 'true';
        btn.onclick = async (e) => {
          const row = e.currentTarget.closest('.member-row');
          const body = row.querySelector('.member-body');
          body.classList.toggle('hidden');
          if (!body.classList.contains('hidden')) {
            const uid = row.dataset.uid;
            const el = row.querySelector('.email');
            try {
              const snap = await get(ref(db, `users/${uid}/private/email`));
              el.textContent = snap.exists() ? snap.val() : '（無）';
            } catch { el.textContent = '（讀取失敗）'; }
          }
        };
      });
      root.querySelectorAll('.member-row .ban-btn').forEach(btn => {
        if (btn.dataset.bound) return;
        btn.dataset.bound = 'true';
        btn.onclick = async (e) => {
          const row = e.currentTarget.closest('.member-row');
          const uid = row.dataset.uid;
          const isBan = bansSet.has(uid);
          if (!confirm(isBan ? '確定要解封？' : '確定要封鎖？')) return;
          try {
            if (isBan) await remove(ref(db, `bans/${uid}`));
            else await set(ref(db, `bans/${uid}`), true);
            alert(isBan ? '已解封' : '已封鎖');
          } catch { alert('操作失敗'); }
        };
      });
    }

    function fmt(ts) {
      if (typeof ts === 'number' && isFinite(ts)) return new Date(ts).toLocaleString();
      const n = Number(ts);
      if (isFinite(n)) return new Date(n).toLocaleString();
      return '—';
    }
  </script>
</body>
</html>