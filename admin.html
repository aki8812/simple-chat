<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <link rel="apple-touch-icon" href="icon/icon-512x512.png" />
  <meta name="theme-color" content="#23272a"/>
  <link rel="manifest" href="manifest.json" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SimpleChat Admin</title>
  <link rel="stylesheet" href="style3.css" />
  <link rel="icon" href="favicon.ico" />
</head>
<body>
  <div class="app-admin">
    <header class="topbar">
      <div class="brand" id="toChat">← 返回聊天室</div>
      <div class="title">成員管理</div>
    </header>
    <section id="listBox" class="list-box">
      <div class="section-title">---載入中---</div>
    </section>
  </div>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { ref, onValue, get, set, remove } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    const listBox = document.getElementById('listBox');
    document.getElementById('toChat').onclick = () => (location.href = 'chat.html');

    const appState = {
      currentUser: null,
      users: new Map(),
      admins: new Set(),
      bans: new Set(),
    };
    
    // --- 同步閘門 ---
    const dataReady = { users: false, admins: false, bans: false };
    let initialCheckPassed = false;
    function checkAllDataReady() {
        if (initialCheckPassed && Object.values(dataReady).every(Boolean)) {
            updateAndRender(); // 首次渲染
        }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return (location.href = 'login.html');
      appState.currentUser = user;

      const adminSnap = await get(ref(db, `admins/${user.uid}`));
      if (!adminSnap.exists() || adminSnap.val() !== true) {
        alert('你沒有權限，無法進入此頁面。');
        return (location.href = 'chat.html');
      }
      
      initialCheckPassed = true; // 初步權限檢查通過
      initializeListeners();
    });

    function initializeListeners() {
        onValue(ref(db, 'users'), (snap) => {
            appState.users.clear();
            snap.forEach(u => {
                const p = u.val()?.profile;
                if (p) appState.users.set(u.key, { uid: u.key, ...p });
            });
            if (!dataReady.users) {
                dataReady.users = true;
                checkAllDataReady();
            } else {
                updateAndRender();
            }
        });

        onValue(ref(db, 'admins'), (snap) => {
            appState.admins.clear();
            snap.forEach(ch => { if (ch.val() === true) appState.admins.add(ch.key); });
            if (!dataReady.admins) {
                dataReady.admins = true;
                checkAllDataReady();
            } else {
                updateAndRender();
            }
        });

        onValue(ref(db, 'bans'), (snap) => {
            appState.bans.clear();
            snap.forEach(ch => { if (ch.val() === true) appState.bans.add(ch.key); });
            if (!dataReady.bans) {
                dataReady.bans = true;
                checkAllDataReady();
            } else {
                updateAndRender();
            }
        });
    }

    function updateAndRender() {
        if (!initialCheckPassed || !Object.values(dataReady).every(Boolean)) return;
        
        // 權限移除檢查
        if (!appState.admins.has(appState.currentUser.uid)) {
            alert('你的管理員權限已被移除。');
            location.href = 'chat.html';
            return;
        }
        renderAdminList();
    }
    
    function renderAdminList() {
        const { users, admins, bans } = appState;
        const adminsList = [], bannedList = [], normalList = [];
        users.forEach(user => {
            if (admins.has(user.uid)) adminsList.push(user);
            else if (bans.has(user.uid)) bannedList.push(user);
            else normalList.push(user);
        });

        const sortFn = (a, b) => (a.nickname || '').localeCompare(b.nickname || '', 'zh-Hant');
        [adminsList, bannedList, normalList].forEach(list => list.sort(sortFn));

        listBox.innerHTML = `
            ${createSectionHtml('---管理員---', adminsList)}
            ${createSectionHtml('---封鎖成員---', bannedList)}
            ${createSectionHtml('---普通成員---', normalList)}
        `;
    }

    function createSectionHtml(title, userArray) {
        const rowsHtml = userArray.length > 0 ? userArray.map(createUserRowHtml).join('') : '<div class="empty">（無）</div>';
        return `<div class="section-title">${title}</div>${rowsHtml}`;
    }

    function createUserRowHtml(user) {
        const { currentUser, admins, bans } = appState;
        const isSelf = user.uid === currentUser.uid;
        const isAdmin = admins.has(user.uid);
        const isBanned = bans.has(user.uid);

        let buttonsHtml = '';
        if (!isSelf) {
            if (isAdmin) {
                buttonsHtml = `<button class="demote-btn danger">移除管理員</button>`;
            } else {
                buttonsHtml = `
                    <button class="promote-btn">設為管理員</button>
                    <button class="ban-btn ${isBanned ? '' : 'danger'}" data-banned="${isBanned}">
                        ${isBanned ? '解封鎖' : '封鎖'}
                    </button>
                `;
            }
        }
        return `
        <div class="member-row ${isAdmin ? 'admin' : ''}" data-uid="${user.uid}">
          <div class="member-head">
            <span class="name">${user.nickname || '（無暱稱）'}</span>
            ${isAdmin ? '<span class="tag-admin">[管理員]</span>' : ''}
            <button class="toggle">▼</button>
          </div>
          <div class="member-body hidden">
            <div>電子郵件：<span class="email">（點上方▼載入）</span></div>
            <div>註冊時間：${fmt(user.registeredAt)}</div>
            <div class="manage-area">${buttonsHtml}</div>
          </div>
        </div>`;
    }

    listBox.addEventListener('click', async (e) => {
        const target = e.target;
        const row = target.closest('.member-row');
        if (!row) return;

        const uid = row.dataset.uid;
        const user = appState.users.get(uid);

        if (target.classList.contains('toggle')) {
            const body = row.querySelector('.member-body');
            body.classList.toggle('hidden');
            if (!body.classList.contains('hidden')) {
                const emailEl = row.querySelector('.email');
                if (emailEl.textContent.includes('載入')) {
                    const snap = await get(ref(db, `users/${uid}/private/email`));
                    emailEl.textContent = snap.val() || '（無）';
                }
            }
        } 
        else if (target.matches('.promote-btn, .demote-btn, .ban-btn')) {
            handleAdminAction(target, uid, user.nickname);
        }
    });

    async function handleAdminAction(target, uid, nickname) {
        const isBanned = appState.bans.has(uid);
        let confirmMsg, actionFn;

        if (target.classList.contains('promote-btn')) {
            confirmMsg = `確定要將 ${nickname} 設為管理員？`;
            actionFn = () => set(ref(db, `admins/${uid}`), true);
        } else if (target.classList.contains('demote-btn')) {
            confirmMsg = `確定要移除 ${nickname} 的管理員權限？`;
            actionFn = () => remove(ref(db, `admins/${uid}`));
        } else if (target.classList.contains('ban-btn')) {
            confirmMsg = isBanned ? `確定要解封 ${nickname}？` : `確定要封鎖 ${nickname}？`;
            actionFn = () => isBanned ? remove(ref(db, `bans/${uid}`)) : set(ref(db, `bans/${uid}`), true);
        }

        if (actionFn && confirm(confirmMsg)) {
            try { await actionFn(); } catch { alert('操作失敗'); }
        }
    }

    function fmt(ts) { return ts ? new Date(ts).toLocaleString() : '—'; }
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>
</body>
</html>