<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SimpleChat Admin</title>
  <link rel="stylesheet" href="style3.css" />
  <link rel="icon" href="favicon.ico" />
</head>
<body>
  <div class="app-admin">
    <header class="topbar">
      <div class="brand" id="toChat">← 返回聊天室</div>
      <div class="title">成員管理</div>
    </header>

    <section id="listBox" class="list-box" aria-live="polite">
      <div class="section-title">---載入中---</div>
    </section>
  </div>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { ref, onValue, get, set, remove } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    const listBox = document.getElementById('listBox');
    document.getElementById('toChat').onclick = () => (location.href = 'chat.html');

    let me = null;
    const users = new Map();
    const adminsSet = new Set();
    const bansSet = new Set();

    let initialDataLoaded = { admins: false, bans: false, users: false };

    onAuthStateChanged(auth, async (u) => {
      if (!u) return (location.href = 'login.html');
      me = u;

      try {
        const adminSnap = await get(ref(db, `admins/${me.uid}`));
        if (!adminSnap.exists()) {
          alert('你沒有權限，無法進入此頁面。');
          location.href = 'chat.html';
          return;
        }
        initializeListeners();
      } catch (error) {
        alert('權限檢查失敗，請稍後再試。');
        location.href = 'chat.html';
      }
    });

    function initializeListeners() {
      onValue(ref(db, 'admins'), (snap) => {
        adminsSet.clear();
        snap.forEach(ch => adminsSet.add(ch.key));
        initialDataLoaded.admins = true;
        if (!adminsSet.has(me.uid) && initialDataLoaded.users) { // 檢查是否中途被拔權限
             alert('你的管理員權限已被移除。');
             location.href = 'chat.html';
             return;
        }
        tryRebuild();
      });

      onValue(ref(db, 'bans'), (snap) => {
        bansSet.clear();
        snap.forEach(ch => bansSet.add(ch.key));
        initialDataLoaded.bans = true;
        tryRebuild();
      });

      onValue(ref(db, 'users'), (snap) => {
        users.clear();
        snap.forEach(u => { const p = u.val()?.profile; if (p) users.set(u.key, p); });
        initialDataLoaded.users = true;
        tryRebuild();
      });

      listBox.addEventListener('scroll', handleScroll);
    }
    
    function tryRebuild() {
      // 確保所有初始資料都已載入，才執行第一次渲染
      if (Object.values(initialDataLoaded).every(Boolean)) {
        rebuild();
      }
    }

    let normalSorted = [];
    let normalRendered = 0;

    function rebuild() {
      const admins = [], banned = [], normal = [];
      users.forEach((p, uid) => {
        const rec = { uid, ...p };
        if (adminsSet.has(uid)) admins.push(rec);
        else if (bansSet.has(uid)) banned.push(rec);
        else normal.push(rec);
      });
      const cmp = (a, b) => (a.nickname || '').localeCompare(b.nickname || '', 'zh-Hant');
      admins.sort(cmp); banned.sort(cmp); normal.sort(cmp);

      normalSorted = normal;
      normalRendered = 0;

      listBox.innerHTML = sectionHtml('---管理員---', admins) +
                          sectionHtml('---封鎖成員---', banned) +
                          `<div class="section-title">---普通成員---</div><div id="normalList"></div>`;
      renderMore();
    }

    function sectionHtml(title, arr) {
      const rows = arr.map(rowHtml).join('') || '<div class="empty">（無）</div>';
      return `<div class="section-title">${title}</div>${rows}`;
    }

    function rowHtml(u) {
      const isAdm = adminsSet.has(u.uid);
      const isBan = bansSet.has(u.uid);
      const isSelf = u.uid === me.uid;
      
      let manageButtons = '';
      if (!isSelf) { // 不能對自己操作
        if (isAdm) {
          manageButtons += `<button class="danger demote-btn" data-uid="${u.uid}">移除管理員</button>`;
        } else {
          manageButtons += `<button class="promote-btn" data-uid="${u.uid}">設為管理員</button>`;
          manageButtons += `<button class="${isBan ? '' : 'danger'} ban-btn" data-uid="${u.uid}" data-banned="${isBan}">${isBan ? '解封鎖' : '封鎖'}</button>`;
        }
      }

      return `
        <div class="member-row ${isAdm ? 'admin' : ''} ${isBan ? 'banned' : ''}" data-uid="${u.uid}">
          <div class="member-head">
            <span class="name">${u.nickname || '（無暱稱）'}</span>
            ${isAdm ? '<span class="tag-admin">[管理員]</span>' : ''}
            <button class="toggle">▼</button>
          </div>
          <div class="member-body hidden">
            <div>電子郵件：<span class="email">（點上方▼載入）</span></div>
            <div>註冊時間：${fmt(u.registeredAt)}</div>
            <div class="manage-area">${manageButtons}</div>
          </div>
        </div>`;
    }
    
    function renderMore() {
      const list = document.getElementById('normalList');
      if (!list) return;
      const next = normalSorted.slice(normalRendered, normalRendered + 25);
      list.insertAdjacentHTML('beforeend', next.map(rowHtml).join(''));
      normalRendered += next.length;
      bindRowEvents(list); 
    }
    
    function handleScroll() {
        if (listBox.scrollTop + listBox.clientHeight >= listBox.scrollHeight - 20) {
          renderMore();
        }
    }
    
    // 使用事件委派來處理所有按鈕點擊，更有效率
    listBox.addEventListener('click', async (e) => {
        const target = e.target;
        const row = target.closest('.member-row');
        if (!row) return;
        const uid = row.dataset.uid;

        if (target.classList.contains('toggle')) {
            const body = row.querySelector('.member-body');
            body.classList.toggle('hidden');
            if (!body.classList.contains('hidden')) {
                const el = row.querySelector('.email');
                if (el.textContent === '（點上方▼載入）') { // 防止重複載入
                    try {
                        const snap = await get(ref(db, `users/${uid}/private/email`));
                        el.textContent = snap.exists() ? snap.val() : '（無）';
                    } catch { el.textContent = '（讀取失敗）'; }
                }
            }
        } else if (target.classList.contains('ban-btn')) {
            const isBanned = target.dataset.banned === 'true';
            if (!confirm(isBanned ? '確定要解封？' : '確定要封鎖？')) return;
            try {
                if (isBanned) await remove(ref(db, `bans/${uid}`));
                else await set(ref(db, `bans/${uid}`), true);
            } catch (err) { alert('操作失敗'); }
        } else if (target.classList.contains('promote-btn')) {
            if (!confirm(`確定要將 ${users.get(uid)?.nickname} 設為管理員？`)) return;
            try {
                await set(ref(db, `admins/${uid}`), true);
            } catch (err) { alert('操作失敗'); }
        } else if (target.classList.contains('demote-btn')) {
            if (!confirm(`確定要移除 ${users.get(uid)?.nickname} 的管理員權限？`)) return;
            try {
                await remove(ref(db, `admins/${uid}`));
            } catch (err) { alert('操作失敗'); }
        }
    });

    function fmt(ts) {
      if (typeof ts === 'number' && isFinite(ts)) return new Date(ts).toLocaleString();
      return '—';
    }
  </script>
</body>
</html>