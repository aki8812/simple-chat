<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SimpleChat 聊天室</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.ico">
</head>
<body>
  <div class="chat-container">
    <header>
      <button id="logout">登出</button>
      <input type="text" id="nicknameInput" placeholder="修改暱稱">
      <button id="saveNick">儲存</button>
    </header>
    <div id="messages" class="chat-box"></div>
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="輸入訊息 (@暱稱可提及)">
      <input type="file" id="imgInput" accept="image/*">
      <button id="sendBtn">送出</button>
    </div>
  </div>

  <!-- user card template -->
  <template id="userCardTmpl">
    <div class="user-card">
      <img src="" class="card-avatar" />
      <div class="card-info">
        <div class="card-name"></div>
        <div class="card-registered"></div>
        <div class="card-history">歷史暱稱：</div>
      </div>
    </div>
  </template>

  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-storage-compat.js"></script>
  <script src="firebase.js"></script>
  <script>
    const user = auth.currentUser;
    if (!user) location.href = "login.html";

    const uid = user.uid;
    const userRef = db.ref("users/" + uid);
    const messagesRef = db.ref("messages");

    document.getElementById("logout").onclick = () => auth.signOut();
    document.getElementById("saveNick").onclick = async () => {
      const newNick = document.getElementById("nicknameInput").value.trim();
      if (!newNick) return;
      const snap = await userRef.once("value");
      const data = snap.val();
      const history = data.nicknameHistory || [];
      history.push(data.nickname);
      await userRef.update({ nickname: newNick, nicknameHistory: history });
      document.getElementById("nicknameInput").value = "";
    };

    document.getElementById("sendBtn").onclick = sendMessage;
    document.getElementById("messageInput").addEventListener("keydown", e => {
      if (e.key==="Enter") sendMessage();
    });

    function sendMessage() {
      const text = document.getElementById("messageInput").value.trim();
      const img = document.getElementById("imgInput").files[0];
      if (!text && !img) return;

      (async ()=>{
        let imageUrl = "", userData = await userRef.once("value");
        const { nickname } = userData.val();
        const msg = { uid, nickname, time: Date.now() };

        if (img) {
          const snap = await storage.ref(`images/${Date.now()}_${img.name}`).put(img);
          imageUrl = await snap.ref.getDownloadURL();
        }
        if (text) msg.text = text;
        if (imageUrl) msg.imageUrl = imageUrl;

        await messagesRef.push(msg);
        document.getElementById("messageInput").value = "";
        document.getElementById("imgInput").value = "";
      })();
    }

    messagesRef.on("child_added", snapshot => {
      addMessage(snapshot.key, snapshot.val());
    });

    async function addMessage(key, msg) {
      const div = document.createElement("div");
      div.classList.add("chat-message");
      div.classList.add(msg.uid===uid? "self":"other");

      const time = new Date(msg.time).toLocaleTimeString();
      const content = document.createElement("div");
      content.innerHTML = `<div class="bubble">
        ${msg.text||""} ${msg.imageUrl? `<br><img src="${msg.imageUrl}" />`:""}
        <div class="bubble-time">${time}</div>
      </div>`;

      // show avatar + name
      const userSnap = await db.ref("users/"+msg.uid).once("value");
      const u = userSnap.val();
      const avatar = document.createElement("img");
      avatar.src = u.avatarUrl || "default.png";
      avatar.className = "avatar";
      avatar.onclick = () => showUserCard(msg.uid);

      div.append(avatar, content);

      // delete button for own or admin
      if (msg.uid===uid || /* your admin check flag */ false) {
        const btn = document.createElement("button");
        btn.textContent = "X";
        btn.className = "del-btn";
        btn.onclick = () => messagesRef.child(key).remove();
        div.appendChild(btn);
      }

      document.getElementById("messages").appendChild(div);
      document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
    }

    async function showUserCard(userId) {
      const snap = await db.ref("users/"+userId).once("value");
      const data = snap.val();
      const regTime = new Date(data.registered||data.time||Date.now()).toLocaleDateString();
      const history = data.nicknameHistory?.join(" → ")||"無";

      const tmpl = document.getElementById("userCardTmpl");
      const clone = tmpl.content.cloneNode(true);
      clone.querySelector(".card-avatar").src = data.avatarUrl || "default.png";
      clone.querySelector(".card-name").textContent = data.nickname;
      clone.querySelector(".card-registered").textContent = "註冊於：" + regTime;
      clone.querySelector(".card-history").textContent = "歷史暱稱：" + history;

      const pop = document.createElement("div");
      pop.className = "popup";
      pop.appendChild(clone);
      document.body.appendChild(pop);
      pop.onclick = () => pop.remove();
    }
  </script>
</body>
</html>
