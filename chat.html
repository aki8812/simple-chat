<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SimpleChat</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="favicon.ico" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-content">
        <div class="brand" id="brandBtn">SimpleChat</div>
        <div id="userListContainer">
          <div class="userlist-loading" style="padding: 6px 8px;">載入使用者列表中...</div>
        </div>
      </div>
      <div id="adminPanel" class="hidden">
        <button id="manageBtn">成員管理</button>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="left">
          <div id="verifyBanner" class="banner hidden">
            尚未完成 Email 驗證，驗證前無法發話。若未收到驗證信，請查看您的垃圾郵件。或者 - >
            <button id="resendVerify" class="linklike">重新寄送驗證信</button>
          </div>
          <div id="banBanner" class="banner hidden">你已被管理員封鎖，無法發話。</div>
        </div>
        <div class="right">
          <input id="newNickname" maxlength="24" placeholder="更改暱稱（3–24 字）" />
          <button id="saveNickname">更新</button>
          <button id="logout" class="danger">登出</button>
        </div>
      </header>

      <section id="messages" class="chat-box" aria-live="polite" aria-label="聊天訊息"></section>

      <div class="input-area">
        <button id="attachBtn" title="附加檔案">+</button>
        <input type="file" id="fileInput" class="hidden" />
        <div class="input-main">
          <div id="filePreview" class="file-preview hidden"></div>
          <input type="text" id="messageInput" placeholder="載入中..." autocomplete="off" disabled />
        </div>
        <button id="sendBtn" type="button" disabled>送出</button>
      </div>
    </main>
  </div>

  <div id="userCard" class="popup hidden"></div>

  <script type="module">
    import { auth, db, storage } from './firebase.js';
    import { onAuthStateChanged, signOut, sendEmailVerification, reload } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { ref as dbRef, push, onChildAdded, query, orderByChild, limitToLast, get, onValue, remove, update, runTransaction, set, startAt } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';
    import { ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js';

    const elements = {
      messagesBox: document.getElementById('messages'),
      inputEl: document.getElementById('messageInput'),
      sendBtn: document.getElementById('sendBtn'),
      userListContainer: document.getElementById('userListContainer'),
      verifyBanner: document.getElementById('verifyBanner'),
      banBanner: document.getElementById('banBanner'),
      resendVerify: document.getElementById('resendVerify'),
      newNickEl: document.getElementById('newNickname'),
      saveNickBtn: document.getElementById('saveNickname'),
      logoutBtn: document.getElementById('logout'),
      userCard: document.getElementById('userCard'),
      brandBtn: document.getElementById('brandBtn'),
      adminPanel: document.getElementById('adminPanel'),
      manageBtn: document.getElementById('manageBtn'),
      attachBtn: document.getElementById('attachBtn'),
      fileInput: document.getElementById('fileInput'),
      filePreview: document.getElementById('filePreview'),
    };

    const appState = {
      currentUser: null,
      users: new Map(),
      admins: new Set(),
      bans: new Set(),
      messages: new Map(),
      latestMessageTime: 0,
      fileToSend: null,
      isUploading: false,
    };

    const MAX_FILE_SIZE = 25 * 1024 * 1024; // 25MB

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = 'login.html';
      try { await reload(user); } catch {}
      appState.currentUser = user;
      await initializeApp();
    });

    async function initializeApp() {
      try {
        const [usersSnap, adminsSnap, bansSnap] = await Promise.all([
          get(dbRef(db, 'users')),
          get(dbRef(db, 'admins')),
          get(dbRef(db, 'bans')),
        ]);

        usersSnap.forEach(u => {
          const p = u.val()?.profile;
          if (p) appState.users.set(u.key, { uid: u.key, ...p });
        });
        adminsSnap.forEach(ch => { if (ch.val() === true) appState.admins.add(ch.key); });
        bansSnap.forEach(ch => { if (ch.val() === true) appState.bans.add(ch.key); });

        await loadInitialMessages();
        updateAndRenderUI();
        attachRealtimeListeners();
        setupEventListeners();

      } catch (error) {
        console.error("初始化失敗:", error);
        alert("無法載入聊天室資料，請稍後重試。");
      }
    }

    function attachRealtimeListeners() {
      onValue(dbRef(db, 'users'), (snap) => {
        appState.users.clear();
        snap.forEach(u => {
          const p = u.val()?.profile;
          if (p) appState.users.set(u.key, { uid: u.key, ...p });
        });
        updateAndRenderUI();
      });

      onValue(dbRef(db, 'admins'), (snap) => {
        appState.admins.clear();
        snap.forEach(ch => { if (ch.val() === true) appState.admins.add(ch.key); });
        updateAndRenderUI();
      });

      onValue(dbRef(db, 'bans'), (snap) => {
        appState.bans.clear();
        snap.forEach(ch => { if (ch.val() === true) appState.bans.add(ch.key); });
        updateAndRenderUI();
      });

      const newMessagesQuery = query(dbRef(db, 'messages'), orderByChild('time'), startAt(appState.latestMessageTime + 1));
      onChildAdded(newMessagesQuery, (snap) => {
          if (appState.messages.has(snap.key)) return;
          const msg = snap.val();
          appState.messages.set(snap.key, msg);
          const el = createMessageElement(snap.key, msg);
          elements.messagesBox.appendChild(el);
          elements.messagesBox.scrollTop = elements.messagesBox.scrollHeight;
      });

      onValue(dbRef(db, 'messages'), (snapshot) => {
        const serverMessages = snapshot.val() || {};
        const serverKeys = new Set(Object.keys(serverMessages));
        const localKeys = Array.from(appState.messages.keys());

        localKeys.forEach(localKey => {
            if (!serverKeys.has(localKey)) {
                appState.messages.delete(localKey);
                const msgElement = elements.messagesBox.querySelector(`[data-msg-id="${localKey}"]`);
                if (msgElement) {
                    msgElement.remove();
                }
            }
        });
      });
    }

    function updateAndRenderUI() {
      renderControls();
      renderUserList();
      renderAllMessages();
    }

    function renderControls() {
        const { currentUser, admins, bans, users, isUploading, fileToSend } = appState;
        const myProfile = users.get(currentUser.uid);
        const isVerified = !!currentUser.emailVerified;
        const isBanned = bans.has(currentUser.uid);
        const hasNick = myProfile && myProfile.nickname;

        elements.verifyBanner.classList.toggle('hidden', isVerified);
        elements.banBanner.classList.toggle('hidden', !isBanned);
        elements.adminPanel.classList.toggle('hidden', !admins.has(currentUser.uid));

        const canPost = isVerified && !isBanned && hasNick;
        const isInputEmpty = !elements.inputEl.value.trim() && !fileToSend;

        elements.inputEl.disabled = !canPost || isUploading;
        elements.attachBtn.disabled = !canPost || isUploading;
        elements.sendBtn.disabled = !canPost || isUploading || isInputEmpty;

        if (isUploading) {
            elements.inputEl.placeholder = '檔案上傳中...';
        } else if (!canPost) {
            elements.inputEl.placeholder = isBanned ? '您已被管理員封鎖' : (!isVerified ? '請先驗證 Email' : '請先設定暱稱');
        } else {
            elements.inputEl.placeholder = '輸入訊息...（可 @暱稱）';
        }

        if(myProfile) elements.newNickEl.value = myProfile.nickname || '';
    }

    function renderUserList() {
        const { currentUser, users, admins, bans } = appState;
        const userArray = Array.from(users.values());
        userArray.sort((a, b) => (a.nickname || '').localeCompare(b.nickname || '', 'zh-Hant'));

        const html = userArray.map(u => {
            const isMe = currentUser.uid === u.uid;
            const isAdmin = admins.has(u.uid);
            const isBanned = bans.has(u.uid);
            const classes = ['userrow', isMe && 'me', isAdmin && 'admin', isBanned && 'banned'].filter(Boolean).join(' ');
            const adminTag = isAdmin ? ' <span class="tag-admin">[管理員]</span>' : '';
            return `<div class="${classes}" data-uid="${u.uid}">@${u.nickname || '未命名'}${adminTag}</div>`;
        }).join('');

        elements.userListContainer.innerHTML = `<div class="userlist">${html}</div>`;
    }

    function renderAllMessages() {
        const sortedMessages = Array.from(appState.messages.entries()).sort((a, b) => a[1].time - b[1].time);
        elements.messagesBox.innerHTML = sortedMessages.map(([key, msg]) => createMessageElement(key, msg).outerHTML).join('');
        elements.messagesBox.scrollTop = elements.messagesBox.scrollHeight;
    }

    async function loadInitialMessages() {
        const msgQuery = query(dbRef(db, 'messages'), orderByChild('time'), limitToLast(30));
        const initialSnap = await get(msgQuery);

        if (initialSnap.exists()) {
            let maxTime = 0;
            initialSnap.forEach(snap => {
                const msg = snap.val();
                appState.messages.set(snap.key, msg);
                if (msg.time > maxTime) maxTime = msg.time;
            });
            appState.latestMessageTime = maxTime;
        }
    }

    function createMessageElement(key, msg) {
        const { currentUser, admins, users } = appState;
        const isSelf = currentUser.uid === msg.uid;
        const isAdmin = admins.has(currentUser.uid);
        const canDelete = isSelf || isAdmin;

        const wrap = document.createElement('div');
        wrap.className = `chat-message ${isSelf ? 'self' : 'other'}`;
        wrap.dataset.msgId = key;

        const myNick = users.get(currentUser.uid)?.nickname;
        if (myNick && msg.text && msg.text.includes(`@${myNick}`) && !isSelf) {
            wrap.classList.add('mention-me');
        }

        const deleteBtnHtml = canDelete ? `<button class="del-btn" data-key="${key}">刪除</button>` : '';
        const authorName = users.get(msg.uid)?.nickname || msg.nickname || '...';

        let contentHtml = '';
        if (msg.text) {
            contentHtml += `<div class="bubble-text">${renderWithMentions(msg.text)}</div>`;
        }
        if (msg.file) {
            const f = msg.file;
            if (f.type.startsWith('image/')) {
                contentHtml += `<img src="${f.url}" alt="${f.name}" class="preview-img" />`;
            } else {
                contentHtml += `
                <a href="${f.url}" target="_blank" class="file-attachment" download="${f.name}">
                    <div class="icon">📄</div>
                    <div class="info">
                        <div class="name">${f.name}</div>
                        <div class="size">${formatBytes(f.size)}</div>
                    </div>
                </a>`;
            }
        }

        wrap.innerHTML = `
        <div class="bubble">
            <div class="bubble-head">
                <div class="bubble-name" data-uid="${msg.uid}">${authorName}</div>
                ${deleteBtnHtml}
            </div>
            ${contentHtml}
            <div class="bubble-time">${fmt(new Date(msg.time))}</div>
        </div>`;
        return wrap;
    }

    async function sendMessage() {
      const text = elements.inputEl.value.trim();
      const file = appState.fileToSend;
      if (!text && !file) return;

      const myProfile = appState.users.get(appState.currentUser.uid);
      appState.isUploading = true;
      renderControls();

      try {
        let fileData = null;
        if (file) {
          const filePath = `${appState.currentUser.uid}/${Date.now()}_${file.name}`;
          const sRef = storageRef(storage, filePath);
          const uploadResult = await uploadBytes(sRef, file);
          const downloadURL = await getDownloadURL(uploadResult.ref);
          fileData = {
            url: downloadURL,
            name: file.name,
            type: file.type,
            size: file.size,
            path: filePath,
          };
        }

        await push(dbRef(db, 'messages'), {
          uid: appState.currentUser.uid,
          nickname: myProfile.nickname,
          text: text,
          time: Date.now(),
          file: fileData,
        });

        elements.inputEl.value = '';
        removeSelectedFile();
      } catch (error) {
        console.error("傳送失敗:", error);
        alert('訊息或檔案傳送失敗。');
      } finally {
        appState.isUploading = false;
        renderControls();
      }
    }

    function setupEventListeners() {
      elements.sendBtn.onclick = sendMessage;
      elements.inputEl.onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
      };
      elements.inputEl.oninput = renderControls;
      elements.logoutBtn.onclick = () => signOut(auth);
      elements.saveNickBtn.onclick = changeNickname;
      elements.brandBtn.onclick = () => location.reload();
      elements.manageBtn.onclick = () => window.location.href = 'admin.html';
      elements.resendVerify.onclick = async () => {
          try { await sendEmailVerification(appState.currentUser); alert('已重新寄出驗證信。'); }
          catch { alert('寄送太頻繁，請稍後再試。'); }
      };

      elements.userListContainer.addEventListener('click', e => {
        const target = e.target.closest('.userrow');
        if(target) openUserCard(target.dataset.uid);
      });

      elements.messagesBox.addEventListener('click', e => {
        if (e.target.classList.contains('del-btn')) {
          const key = e.target.dataset.key;
          const msg = appState.messages.get(key);
          if (confirm('確定要刪除此訊息？')) {
            remove(dbRef(db, `messages/${key}`)).catch(() => alert('刪除失敗'));
            if (msg && msg.file && msg.file.path) {
                deleteObject(storageRef(storage, msg.file.path)).catch(err => console.error("檔案刪除失敗", err));
            }
          }
        }
        if (e.target.classList.contains('bubble-name')) {
          openUserCard(e.target.dataset.uid);
        }
      });

      elements.attachBtn.onclick = () => elements.fileInput.click();
      elements.fileInput.onchange = handleFileSelection;

      // 使用事件委派處理檔案預覽的移除
      elements.filePreview.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-file')) {
          removeSelectedFile();
        }
      });
    }

    function handleFileSelection(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > MAX_FILE_SIZE) {
            alert(`檔案大小不可超過 ${formatBytes(MAX_FILE_SIZE)}`);
            elements.fileInput.value = ''; // Clear selection
            return;
        }
        appState.fileToSend = file;
        renderFilePreview();
        renderControls();
    }

    function removeSelectedFile() {
        appState.fileToSend = null;
        elements.fileInput.value = '';
        renderFilePreview();
        renderControls();
    }

    function renderFilePreview() {
        if (appState.fileToSend) {
            elements.filePreview.innerHTML = `
                <span>${appState.fileToSend.name} (${formatBytes(appState.fileToSend.size)})</span>
                <span class="remove-file" title="移除檔案">×</span>
            `;
            elements.filePreview.classList.remove('hidden');
        } else {
            elements.filePreview.classList.add('hidden');
        }
    }

    async function changeNickname() {
        const newNick = elements.newNickEl.value.trim();
        if (newNick.length < 3 || newNick.length > 24) return alert('暱稱需 3–24 字');
        const uid = appState.currentUser.uid;
        const myProfile = appState.users.get(uid);
        const lower = newNick.toLowerCase();
        const oldLower = myProfile?.nicknameLower || '';
        if(lower === oldLower) return;
        try {
            const res = await runTransaction(dbRef(db, `nicknames/${lower}`), (cur) => (cur === null || cur === uid) ? uid : undefined);
            if (!res.committed) return alert('暱稱已被使用，請換一個');
            await update(dbRef(db, `users/${uid}/profile`), { nickname: newNick, nicknameLower: lower });
            if (oldLower) await set(dbRef(db, `nicknames/${oldLower}`), null);
            alert('已更新暱稱');
        } catch (e) { alert('更新失敗，請稍後再試'); }
    }

    function openUserCard(uid) {
        const { currentUser, users, admins, bans } = appState;
        const targetUser = users.get(uid);
        if (!targetUser) return;

        const isMe = currentUser.uid === uid;
        const isCurrentUserAdmin = admins.has(currentUser.uid);
        const canManage = isCurrentUserAdmin && !isMe;

        const isTargetBanned = bans.has(uid);
        const isTargetAdmin = admins.has(uid);

        let adminButtonHtml = '';
        if (canManage) {
            adminButtonHtml = `<button id="promoteBtn" class="${isTargetAdmin ? 'danger' : 'promote'}">${isTargetAdmin ? '移除管理員' : '設為管理員'}</button>`;
        }

        const banButtonHtml = canManage
            ? `<button id="banBtn" class="${isTargetBanned ? '' : 'danger'}">${isTargetBanned ? '解封鎖' : '封鎖此用戶'}</button>`
            : '';

        elements.userCard.innerHTML = `
        <div class="user-card">
          <div class="card-name">@${targetUser.nickname} ${isTargetAdmin ? '<span class="tag-admin">[管理員]</span>' : ''}</div>
          <div class="card-registered">註冊時間：${fmt(targetUser.registeredAt)}</div>
          <div class="card-actions">
            ${adminButtonHtml}
            ${banButtonHtml}
            <button id="closeCard">關閉</button>
          </div>
        </div>`;
        elements.userCard.classList.remove('hidden');

        const closeBtn = document.getElementById('closeCard');
        if (closeBtn) closeBtn.onclick = () => elements.userCard.classList.add('hidden');

        const banBtn = document.getElementById('banBtn');
        if (banBtn) banBtn.onclick = async () => {
          if (!confirm(isTargetBanned ? '確定要解封？' : '確定封鎖此用戶？')) return;
          const targetRef = dbRef(db, `bans/${uid}`);
          try {
            await (isTargetBanned ? remove(targetRef) : set(targetRef, true));
            elements.userCard.classList.add('hidden');
          } catch { alert('操作失敗'); }
        };

        const promoteBtn = document.getElementById('promoteBtn');
        if (promoteBtn) {
            promoteBtn.onclick = async () => {
                const actionText = isTargetAdmin ? '移除其管理員權限' : '將其設為管理員';
                if (!confirm(`確定要${actionText}？`)) return;
                const targetRef = dbRef(db, `admins/${uid}`);
                try {
                    await (isTargetAdmin ? remove(targetRef) : set(targetRef, true));
                    elements.userCard.classList.add('hidden');
                } catch (err) { alert('操作失敗'); }
            };
        }
    }

    function renderWithMentions(text) {
        if (!text) return '';
        const names = new Set(Array.from(appState.users.values()).map(u => u.nickname).filter(Boolean));
        const escaped = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        return escaped.replace(/(^|\s)@([\p{L}\p{N}_-]{3,24})/gu, (m, sp, name) =>
            names.has(name) ? `${sp}<span class="mention">@${name}</span>` : m
        );
    }

    function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }

    function fmt(ts) { return ts ? new Date(ts).toLocaleString() : '—'; }
  </script>
</body>
</html>