<!DOCTYPE html>
return text.replace(/(^|\s)@([\p{L}\p{N}_-]{3,24})/gu, (m, sp, name) => {
return names.has(name) ? `${sp}<span class="mention">@${name}</span>` : m;
});
}


// ===== 更改暱稱（唯一） =====
async function changeNickname() {
if (!me) return;
const newNick = (newNickEl.value || '').trim();
if (newNick.length < 3 || newNick.length > 24) { return alert('暱稱需 3–24 字'); }
const lower = newNick.toLowerCase();
const oldLower = (myProfile?.nicknameLower || '').toLowerCase();


try {
// 先佔用新暱稱
const res = await runTransaction(ref(db, `nicknames/${lower}`), (cur) => {
if (cur === null || cur === me.uid) return me.uid;
return; // 已被占用
});
if (!res.committed) return alert('暱稱已被使用，請換一個');


// 釋放舊暱稱（若是本人佔用）
if (oldLower && lower !== oldLower) {
await runTransaction(ref(db, `nicknames/${oldLower}`), (cur) => (cur === me.uid ? null : cur));
}


await update(ref(db, `users/${me.uid}/profile`), { nickname: newNick, nicknameLower: lower });
alert('已更新暱稱');
} catch (e) {
alert('更新失敗，稍後再試');
}
}


// ===== 使用者名單與卡片 =====
function renderUserList() {
const arr = Array.from(users.entries()).map(([uid, p]) => ({ uid, ...p }));
arr.sort((a,b) => a.nickname.localeCompare(b.nickname, 'zh-Hant'));
userListEl.innerHTML = arr.map(u => `<div class="userrow" data-uid="${u.uid}">@${u.nickname}</div>`).join('');
userListEl.querySelectorAll('.userrow').forEach((el) => el.addEventListener('click', () => openUserCard(el.dataset.uid)));
}


function openUserCard(uid) {
const p = users.get(uid); if (!p) return;
const isMe = me && uid === me.uid;
const canBan = isAdmin && !isMe;
userCard.innerHTML = `
<div class="user-card">
<div class="card-info">
<div class="card-name">@${p.nickname}</div>
<div class="card-registered">註冊時間：${new Date(p.registeredAt).toLocaleString()}</div>
${canBan ? `<div style="margin-top:10px"><button id="banBtn" class="danger">封鎖此用戶</button></div>` : ''}
<div style="margin-top:10px"><button id="closeCard">關閉</button></div>
</div>
</div>`;
userCard.classList.remove('hidden');
document.getElementById('closeCard').onclick = () => userCard.classList.add('hidden');
const banBtn = document.getElementById('banBtn');
if (banBtn) banBtn.onclick = async () => { if(confirm('確定封鎖此用戶？')) { await update(ref(db, `bans/${uid}`), true); alert('已封鎖'); userCard.classList.add('hidden'); } };
}
</script>
</body>
</html>