<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>簡單聊天室</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="favicon.ico" />
  <style>

    .input-area button { min-width: 92px; }
  </style>
</head>
<body>
  <div class="chat-container">
    <div id="messages" class="chat-box" aria-live="polite" aria-label="聊天訊息"></div>
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="輸入訊息..." autocomplete="off" />
      <button id="sendBtn" type="button">送出</button>
    </div>
  </div>


  <script type="module">
    import { auth, db } from './firebase.js';
    import { ref, push, onChildAdded } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';


    onAuthStateChanged(auth, (user) => {
      if (!user) {

        window.location.href = 'login.html';
      }
    });


    const messagesRef = ref(db, 'messages');


    const inputEl = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesBox = document.getElementById('messages');

    async function sendMessage() {
      const text = (inputEl.value || '').trim();
      if (!text) return;

      const msg = {
        text,
        time: Date.now(),
      };

      try {
        await push(messagesRef, msg);
        inputEl.value = '';
        inputEl.focus();
      } catch (err) {
        console.error('送出訊息失敗：', err);
        alert('訊息傳送失敗，請稍後再試。');
      }
    }


    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });
    sendBtn.addEventListener('click', sendMessage);


    onChildAdded(messagesRef, (snapshot) => {
      const message = snapshot.val();
      const timeStr = new Date(message.time).toLocaleTimeString();

      const msgElement = document.createElement('div');
      msgElement.className = 'chat-message';
      msgElement.textContent = `[${timeStr}] ${message.text}`;

      messagesBox.appendChild(msgElement);
      messagesBox.scrollTop = messagesBox.scrollHeight;
    });
  </script>
</body>
</html>
