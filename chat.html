<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SimpleChat</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="favicon.ico" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">SimpleChat</div>
      <div class="userlist" id="userList"></div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="left">
          <div id="verifyBanner" class="banner hidden">
            å°šæœªå®Œæˆ Email é©—è­‰ï¼Œé©—è­‰å‰ç„¡æ³•ç™¼è©±ã€‚
            <button id="resendVerify" class="linklike">é‡æ–°å¯„é€é©—è­‰ä¿¡</button>
            <button id="toggleUsers">ğŸ‘¥</button>
          </div>
          <div id="banBanner" class="banner hidden">ä½ å·²è¢«ç®¡ç†å“¡å°é–ï¼Œç„¡æ³•ç™¼è©±ã€‚</div>
        </div>
        <div class="right">
          <input id="newNickname" maxlength="24" placeholder="æ›´æ”¹æš±ç¨±ï¼ˆ3â€“24 å­—ï¼‰" />
          <button id="saveNickname">æ›´æ–°</button>
          <button id="logout" class="danger">ç™»å‡º</button>
        </div>
      </header>

      <section id="messages" class="chat-box" aria-live="polite" aria-label="èŠå¤©è¨Šæ¯"></section>

      <div class="input-area">
        <input type="text" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯...ï¼ˆå¯ @æš±ç¨±ï¼‰" autocomplete="off" />
        <button id="sendBtn" type="button">é€å‡º</button>
      </div>
    </main>
  </div>

  <!-- ä½¿ç”¨è€…å¡ç‰‡ -->
  <div id="userCard" class="popup hidden"></div>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged, signOut, sendEmailVerification, reload } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { ref, push, onChildAdded, query, orderByChild, limitToLast, endAt, get, onValue, remove, update, runTransaction } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    const messagesRef = ref(db, 'messages');
    const usersRef    = ref(db, 'users');

    const messagesBox   = document.getElementById('messages');
    const inputEl       = document.getElementById('messageInput');
    const sendBtn       = document.getElementById('sendBtn');
    const userListEl    = document.getElementById('userList');
    const verifyBanner  = document.getElementById('verifyBanner');
    const banBanner     = document.getElementById('banBanner');
    const resendVerify  = document.getElementById('resendVerify');
    const newNickEl     = document.getElementById('newNickname');
    const saveNickBtn   = document.getElementById('saveNickname');
    const logoutBtn     = document.getElementById('logout');
    const userCard      = document.getElementById('userCard');

    let me = null;
    let myProfile = null;
    let isAdmin = false;
    let isBanned = false;

    const users = new Map();  // uid -> { nickname, nicknameLower, registeredAt }

    const PAGE = 25;
    let oldestTime = Number.MAX_SAFE_INTEGER;
    const loadedKeys = new Set();

    // ===== Auth & åˆå§‹è¼‰å…¥ =====
    onAuthStateChanged(auth, async (user) => {
      if (!user) return (window.location.href = 'login.html');
      me = user;
      try { await reload(me); } catch {}

      // è§’è‰²ç›£è½
      onValue(ref(db, `admins/${me.uid}`), (s) => { isAdmin = !!s.val(); refreshControls(); });
      onValue(ref(db, `bans/${me.uid}`),   (s) => { isBanned = !!s.val(); refreshControls(); });

      // æˆ‘çš„æª”æ¡ˆ
      onValue(ref(db, `users/${me.uid}/profile`), async (s) => {
        if (!s.exists()) {
          const nick = `User_${me.uid.slice(0,6)}`;
          await update(ref(db, `users/${me.uid}`), {
            profile: { nickname: nick, nicknameLower: nick.toLowerCase(), registeredAt: Date.now() },
            private: { email: me.email || '' }
          });
        } else {
          myProfile = s.val();
          newNickEl.value = myProfile.nickname || '';
        }
      });

      // å…¨ä½¿ç”¨è€…åˆ—è¡¨
      onValue(usersRef, (snap) => {
        users.clear();
        snap.forEach((u) => {
          const p = u.val()?.profile; if (p) users.set(u.key, p);
        });
        renderUserList();
      });

      // åˆå§‹è¨Šæ¯
      const baseQ = query(messagesRef, orderByChild('time'), limitToLast(PAGE));
      onChildAdded(baseQ, (snap) => addMessage(snap.key, snap.val(), false));

      // ä¸Šæ²è¼‰æ›´å¤š
      messagesBox.addEventListener('scroll', async () => {
        if (messagesBox.scrollTop < 20) {
          await loadMore();
        }
      });

      // æ§åˆ¶é …äº‹ä»¶
      sendBtn.addEventListener('click', sendMessage);
      inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); }});
      logoutBtn.addEventListener('click', () => signOut(auth));
      resendVerify.addEventListener('click', async () => { try { await sendEmailVerification(me); alert('å·²é‡æ–°å¯„å‡ºé©—è­‰ä¿¡ã€‚'); } catch(e) { alert('å¯„é€å¤±æ•—ï¼Œç¨å¾Œå†è©¦'); } });
      saveNickBtn.addEventListener('click', changeNickname);

      refreshControls();
    });

    function refreshControls() {
      if (!me) return;
      const verified = !!me.emailVerified;
      verifyBanner.classList.toggle('hidden', verified);
      banBanner.classList.toggle('hidden', !isBanned);
      const disabled = !verified || isBanned;
      inputEl.disabled = disabled; sendBtn.disabled = disabled;
    }

    // ===== ç™¼é€è¨Šæ¯ =====
    async function sendMessage() {
      if (!me) return;
      if (!me.emailVerified) { alert('ä½ å°šæœªå®Œæˆ Email é©—è­‰ï¼Œé©—è­‰å¾Œæ‰å¯ç™¼è©±ã€‚'); return; }
      if (isBanned) { alert('ä½ å·²è¢«å°é–ï¼Œç„¡æ³•ç™¼è©±'); return; }

      const text = (inputEl.value || '').trim();
      if (!text) return;
      const nick = myProfile?.nickname || 'æœªçŸ¥ç”¨æˆ¶';

      try {
        await push(messagesRef, { uid: me.uid, text, time: Date.now(), nickname: nick });
        inputEl.value = '';
      } catch (err) {
        alert('è¨Šæ¯å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
      }
    }

    // ===== è®€å–èˆ‡æ¸²æŸ“è¨Šæ¯ =====
    function addMessage(key, msg, prepend) {
      if (!msg || loadedKeys.has(key)) return;
      loadedKeys.add(key);
      oldestTime = Math.min(oldestTime, msg.time || Date.now());

      const isSelf = me && msg.uid === me.uid;
      const wrap = document.createElement('div');
      wrap.className = `chat-message ${isSelf ? 'self' : 'other'}`;

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      const name = document.createElement('div');
      name.className = 'bubble-name';
      name.textContent = msg.nickname || users.get(msg.uid)?.nickname || 'ï¼ˆå·²åˆªé™¤ç”¨æˆ¶ï¼‰';
      name.addEventListener('click', () => openUserCard(msg.uid));

      const content = document.createElement('div');
      content.className = 'bubble-text';
      content.innerHTML = renderWithMentions(msg.text);

      const time = document.createElement('div');
      time.className = 'bubble-time';
      time.textContent = new Date(msg.time).toLocaleString();

      const head = document.createElement('div');
      head.className = 'bubble-head';
      head.appendChild(name);

      if (me && (isSelf || isAdmin)) {
        const del = document.createElement('button');
        del.className = 'del-btn';
        del.textContent = 'åˆªé™¤';
        del.addEventListener('click', async () => {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨Šæ¯ï¼Ÿ')) return;
          try { await remove(ref(db, `messages/${key}`)); } catch(e) { alert('åˆªé™¤å¤±æ•—'); }
        });
        head.appendChild(del);
      }

      bubble.appendChild(head);
      bubble.appendChild(content);
      bubble.appendChild(time);
      wrap.appendChild(bubble);

      if (prepend) {
        messagesBox.insertBefore(wrap, messagesBox.firstChild);
      } else {
        messagesBox.appendChild(wrap);
        messagesBox.scrollTop = messagesBox.scrollHeight;
      }
    }

    async function loadMore() {
      const moreQ = query(messagesRef, orderByChild('time'), endAt(oldestTime - 1), limitToLast(PAGE));
      const snap = await get(moreQ);
      const arr = [];
      snap.forEach((child) => arr.push([child.key, child.val()]));
      arr.forEach(([k, v]) => addMessage(k, v, true));
    }

    function renderWithMentions(text) {
      if (!text) return '';
      const names = new Set(Array.from(users.values()).map(u => u.nickname));
      return text.replace(/(^|\s)@([\p{L}\p{N}_-]{3,24})/gu, (m, sp, name) => {
        return names.has(name) ? `${sp}<span class="mention">@${name}</span>` : m;
      });
    }

    // ===== æ›´æ”¹æš±ç¨±ï¼ˆå”¯ä¸€ï¼Œä¿®æ­£ç‰ˆï¼‰ =====
    async function changeNickname() {
      if (!me) return;
      const newNick = (newNickEl.value || '').trim();
      if (newNick.length < 3 || newNick.length > 24) {
        alert('æš±ç¨±éœ€ 3â€“24 å­—');
        return;
      }
      const lower = newNick.toLowerCase();
      const oldLower = (myProfile?.nicknameLower || '').toLowerCase();

      try {
        // 1. ä½”ç”¨æ–°æš±ç¨±
        const res = await runTransaction(ref(db, `nicknames/${lower}`), (cur) => {
          if (cur === null || cur === me.uid) return me.uid;
          return;
        });
        if (!res.committed) {
          alert('æš±ç¨±å·²è¢«ä½¿ç”¨ï¼Œè«‹æ›ä¸€å€‹');
          return;
        }

        // 2. æ›´æ–° profile
        await update(ref(db, `users/${me.uid}/profile`), {
          nickname: newNick,
          nicknameLower: lower
        });

        // 3. é‡‹æ”¾èˆŠæš±ç¨±
        if (oldLower && lower !== oldLower) {
          await runTransaction(ref(db, `nicknames/${oldLower}`), (cur) => {
            if (cur === me.uid) return null;
            return cur;
          });
        }

        alert('å·²æ›´æ–°æš±ç¨±');
      } catch (e) {
        console.error(e);
        alert('æ›´æ–°å¤±æ•—ï¼Œç¨å¾Œå†è©¦');
      }
    }

    // ===== ä½¿ç”¨è€…åå–®èˆ‡å¡ç‰‡ =====
    function renderUserList() {
      const arr = Array.from(users.entries()).map(([uid, p]) => ({ uid, ...p }));
      arr.sort((a,b) => a.nickname.localeCompare(b.nickname, 'zh-Hant'));
      userListEl.innerHTML = arr.map(u => `<div class="userrow" data-uid="${u.uid}">@${u.nickname}</div>`).join('');
      userListEl.querySelectorAll('.userrow').forEach((el) => el.addEventListener('click', () => openUserCard(el.dataset.uid)));
    }

    function openUserCard(uid) {
      const p = users.get(uid); if (!p) return;
      const isMe = me && uid === me.uid;
      const canBan = isAdmin && !isMe;
      userCard.innerHTML = `
        <div class="user-card">
          <div class="card-info">
            <div class="card-name">@${p.nickname}</div>
            <div class="card-registered">è¨»å†Šæ™‚é–“ï¼š${new Date(p.registeredAt).toLocaleString()}</div>
            ${canBan ? `<div style="margin-top:10px"><button id="banBtn" class="danger">å°é–æ­¤ç”¨æˆ¶</button></div>` : ''}
            <div style="margin-top:10px"><button id="closeCard">é—œé–‰</button></div>
          </div>
        </div>`;
      userCard.classList.remove('hidden');
      document.getElementById('closeCard').onclick = () => userCard.classList.add('hidden');
      const banBtn = document.getElementById('banBtn');
      if (banBtn) banBtn.onclick = async () => { if(confirm('ç¢ºå®šå°é–æ­¤ç”¨æˆ¶ï¼Ÿ')) { await update(ref(db, `bans/${uid}`), true); alert('å·²å°é–'); userCard.classList.add('hidden'); } };
    }
  </script>
</body>
</html>